<!DOCTYPE html>
<html>
<body>
<div id="wrapper" class="wrapper"></div>
</body>
<script>
snapStr = {"date":1391636691,"list":[[126634,2,7133184,1708],[126635,2,9282851,1708],[126638,2,9135176,1708],[126639,2,7081584,1708],[126629,2,9282851,1708],[126623,2,9282851,1708],[126872,2,7162080,1708],[126877,2,7161048,1708],[126646,2,4876008,1708],[127112,2,7161048,1708],[127117,2,7161048,1708],[127000,2,4464390,1708],[126920,2,4100011,1708],[127352,2,7162080,1708],[127613,2,7176528,1708],[127617,2,5014728,1708],[127621,2,8042454,1708],[127547,2,7141758,1708],[127555,2,8003394,1708],[127536,2,7141758,1708],[127538,2,7579152,1708],[127525,2,7141758,1708],[127514,2,7141758,1708],[127522,2,8003394,1708],[127481,2,7106988,1708],[127390,2,7886214,1708],[127365,2,4922248,1708],[127366,2,4922248,1708],[127368,2,7808094,1708],[127669,2,8518718,1708]]};

buildings = []; sections = [];
buildings [1708] = { flatStartId: 126496, sectionsQ: 6 }
buildings [1709] = { flatStartId: 127673, sectionsQ: 3 }
buildings [1710] = { flatStartId: 128537, sectionsQ: 8 }
/*
<td class="free buildroom room_[123] set_([^"]*)"><a href="\?id=([0-9]{6})&build=(1709|1708|1710)">[^<]*</a></td>
status
0 - never available
1 - available
2 - fixed
3 - sold out
*/
sectionPrototype = {	
	floorsFrom: 2, floorsTo: 25,
	getPlan: function(floor){ return this.plans[0]; }
	}

sections[1708] = [
	function () { this.plans = [ [[2,69.12],[3,94.29],[2,63.36],[2,63.33],[3,92.79],[2,68.62]] ] },
	function () { this.plans = [ [[1,30.37],[1,42.5],[2,69.4],[1,46.24],[1,46.24],[1,46.24],[1,46.24],[2,69.39],[1,41.2],[1,30.5]] ] },
	function () { this.plans = [ [[1,30.37],[1,42.5],[2,69.39],[1,46.24],[1,46.24],[1,46.24],[1,46.24],[2,69.39],[1,42.32],[1,30.37]] ] },
	function () { this.plans = [ [[1,30.36],[1,42.33],[2,69.4],[1,46.24],[1,46.24],[1,46.24],[1,46.24],[2,69.31],[1,42.33],[1,30.36]] ] },
	function () { this.plans = [ [[2,69.54],[1,42.37],[2,74.16],[1,46.24],[1,46.24],[1,46.24],[1,46.24],[1,32.72],[3,78.12],[1,33.59],[1,33.59]] ]},
	function () { this.plans = [ [[3,81.85],[1,30.08],[1,30.08],[1,31.13],[1,47.12],[2,57.81]], [[3,83.15],[1,30.05],[1,30.05],[1,31.05],[1,47]], [[3,83.15],[1,30.05],[1,30.05],[1,31.05]] ];
		this.floorsTo = 11;
		this.getPlan = function(floor){
			var index = 0;
			if(floor >= 7) index = 2;
			else if(floor === 6) index = 1;
			return this.plans[index];
			}
		}
	];

sections[1709] = [
	function () { this.plans = [ [[2,74.89], [3,89.37], [3,83.58], [2,64.76], [1,45.43], [1,45.43], [1,45.43], [1,45.43], [2,69.53], [2,74.25]] ]},
	function () { this.plans = [ [[1,50.29],[1,48.37],[1,43.55],[1,29.57],[1,28.76],[1,29.14],[1,29.14],[1,29.14],[1,29.14],[1,29.32],[2,64.73],[1,29.43],[1,49.25]]	]},
	function () { this.plans = [ [[1,50.13],[1,49.46],[1,43.08],[1,29.57],[1,28.76],[1,29.14],[1,29.14],[1,29.14],[1,29.14],[1,29.32],[2,64.73],[1,30.18],[1,49.9]] ]}
	];
	
sections[1710] = [
	function () { this.floorsFrom = 3; this.floorsTo = 16; this.plans = [ [[2,71.5], [1,44.5], [1,30.9], [1,44.5], [3,94.8]] ] },
	function () { this.floorsFrom = 3; this.floorsTo = 18; this.plans = [ [[2,57.4], [1,38.9], [1,44.6], [2,75.66]] ] },
	function () { this.plans = [ [[3,85], [2,75.8], [1,46.25], [1,28.7], [1,28.7], [1,28.73], [3,90.7]] ]	},
	function () { this.plans = [ [[3,95.19], [1,29.16], [1,30], [1,30], [1,30], [1,30], [1,29.16], [3,94.19]] ] },
	function () { this.plans = [ [[3,93.5], [1,27.83], [1,28.7], [1,28.7], [1,47.05], [2,63.4], [1,41.1]] ] }, //differs from documents
	function () { this.floorsTo = 13; this.plans = [ [[4,120.42], [1,28.95], [1,43.2], [1,44.9], [3,84.31]] ]},
	function () { this.floorsTo = 13; this.plans = [ [[3,100.1], [1,46.4], [1,46.4], [1,32.05], [3,90.17]] ] },
	function () { this.floorsTo = 13; this.plans = [ [[2,68.57], [1,30.85], [1,46.45], [1,31], [3,78.97]] ] }
	];
	
	
function addSectionPrototype(objArr){ objArr.forEach( function(section){ section.prototype = sectionPrototype; }); }
sections.forEach(addSectionPrototype);

/*	
floorPlans[1708] = []; floorPlans[1709] = []; floorPlans[1710] = [];
floorPlans[1708][0] = [[2,69.12],[3,94.29],[2,63.36],[2,63.33],[3,92.79],[2,68.62]];
floorPlans[1708][1] = [[1,30.37],[1,42.5],[2,69.4],[1,46.24],[1,46.24],[1,46.24],[1,46.24],[2,69.39],[1,41.2],[1,30.5]];
floorPlans[1708][2] = [[1,30.37],[1,42.5],[2,69.39],[1,46.24],[1,46.24],[1,46.24],[1,46.24],[2,69.39],[1,42.32],[1,30.37]];
floorPlans[1708][3] = [[1,30.36],[1,42.33],[2,69.4],[1,46.24],[1,46.24],[1,46.24],[1,46.24],[2,69.31],[1,42.33],[1,30.36]];
floorPlans[1708][4] = [[2,69.54],[1,42.37],[2,74.16],[1,46.24],[1,46.24],[1,46.24],[1,46.24],[1,32.72],[3,78.12],[1,33.59],[1,33.59]];
floorPlans[1708][5] = [[3,81.85],[1,30.08],[1,30.08],[1,31.13],[1,47.12],[2,57.81]];//1-5 floor of 6th section
floorPlans[1708][6] = [[3,83.15],[1,30.05],[1,30.05],[1,31.05],[1,47]];//6-th floor of 6th section
floorPlans[1708][7] = [[3,83.15],[1,30.05],[1,30.05],[1,31.05]];//7-th floor of 6th section

floorPlans[1709][0] = [[2,74.89],[3,89.37],[3,83.58],[2,64.76],[1,45.43],[1,45.43],[1,45.43],[1,45.43],[2,69.53],[2,74.25]];
floorPlans[1709][1] = [[1,50.29],[1,48.37],[1,43.55],[1,29.57],[1,28.76],[1,29.14],[1,29.14],[1,29.14],[1,29.14],[1,29.32],[2,64.73],[1,29.43],[1,49.25]];
floorPlans[1709][2] = [[1,50.13],[1,49.46],[1,43.08],[1,29.57],[1,28.76],[1,29.14],[1,29.14],[1,29.14],[1,29.14],[1,29.32],[2,64.73],[1,30.18],[1,49.9]];
*/
/*
flatId
floor
numberOnFloor
numberOfRooms
square
building
section
status: [[date, status,price4meter]]
*/

function repeatePlease(str, quantity){
	var res = "";
	while(quantity > 0) { res += str; quantity--; }
	return res;
	}

/*function section2k(secId){ this.getPlan = function (floorNumber){	return floorPlans[1709][secId]; } }	
section2k.prototype = secPrototype;

function section1k(secId){ this.getPlan = function (floorNumber){	return floorPlans[1708][secId]; } }
section1k.prototype = secPrototype;
	
function section1k6s(){
	this.floorsTo = 11;
	this.getPlan = function (floorNumber) {
		var res = floorPlans[1708][5];
		if(floorNumber === 6) res = floorPlans[1708][6];
		else if(floorNumber >= 7) res = floorPlans[1708][7];
		return res;
		}
	}*/
	
function drawTable(bId){
	/*function maxNumberFlatsOfSection(sectionId){
		function max (prev, elem){ return Math.max(prev, elem.length); }
		var columns = floorPlans[buildingId][sectionId].length;
		console.log("columns: " + columns);
		return columns;
		}*/
	function floorBuilder(base, elem){
		function spellRoomNumber(type){
			var res = "";
			switch (type){
				case 0: res = "студия"; break;
				case 1: res = "однушка"; break;
				case 2: res = "двушка"; break;
				case 3: res = "трёшка"; break;
				case 4: res = "четвёрка"; break;				
				}
			return res;
			}
		var str,
		flatType = (elem[0] === 1 && elem[1] < 34)? 0 : elem[0]; //zero for studio
		str = base + "<td class='flat roomsNum_" + flatType + "'>";
		str += "<div class='popup'>" + spellRoomNumber(flatType) + ", " + elem[1] + "<br>цена: " + "<br>номер: " +  "</div></td>";
		//"<font title='площадь:" + elem[1] + "'>&nbsp;";
		//str += (elem[0] === 1 && elem[1] < 34)?"C":elem[0];
		//str += "</font></td>";
		return str;
		}
	function buildSectionColumnsLegend(plan){
		function builder(base, elem){
			var str = base + "<td><font>";
			str += (elem[0] === 1 && elem[1] < 34)?"C":elem[0];
			str += "</font></td>";
			return str;
			}
		return "<tr class='sectionColumnsLegend'><td class='floor'>&nbsp;</td>" + plan.reduce(builder,"") + "</tr>";
		}
	var
		plan, i, j, str = "<table class='building'><tr>",
		section, rows = sectionPrototype.floorsTo, columns;
	for (i = 0; i<buildings[bId].sectionsQ; i++){
		//if(buildingId === 1709) section = new section2k(i);
		//else if(buildingId === 1708) section = new ((i === 5)?section1k6s:section1k)(i);
		section = new sections[bId][i];
		columns = section.plans[0].length; // надо вычислить максимальный
		str += "<td class='section'><table class='section'>";
		str += buildSectionColumnsLegend(section.getPlan(section.floorsFrom));
		//for (j = rows; j > section.floorsTo; j--)
		//	str += "<tr><td colspan='" + columns + "'>&nbsp;</td></tr>"
		for (j = section.floorsTo; j >= section.floorsFrom; j--){
			plan = section.getPlan(j);
			str += "<tr>" + "<td class='floor'>" + j + "</td>" + plan.reduce(floorBuilder,"");
			str += (columns>plan.length)?("<td colspan='" + (columns - plan.length) + "'>&nbsp;</td>"):"";
			str += "</tr>";
			}
		for (;j >= 1; j--){//добавляем нежилые этажи чтобы с первого
			if(j === 1) str += buildSectionColumnsLegend(section.getPlan(section.floorsFrom));
			else str += "<tr class='emptyFloor'>" + "<td class='floor'>&nbsp;</td>" + "<td colspan='" + columns + "'>&nbsp;</td></tr>";
			}
		str += "</table></td>";
		}
	return str+"</tr></table>";
	}
	

function buildTable(bId){
	var
		table = [], plan,
		i, j, section,
		flatId = buildings[bId].flatStartId;
	for (i = 0; i < buildings[bId].sectionsQ; i++){
		section = new sections[bId][i];
		for(j = section.floorsFrom; j <= section.floorsTo; j++){
			plan = section.getPlan(j);
			plan.forEach(function(elem, elemId){
				table[flatId] = {
					floor:j,
					numberOnFloor:elemId+1,
					numberOfRooms:elem[0],
					square:elem[1],
					building:bId,
					section:i,
					status:[]
					};
				flatId++;
				});
			} 
		}
	return table;
	}

//table = buildTable(1709)
//console.log(table.filter(function(value) { return value.building !== undefined }).length);
tableStr = drawTable(1710);
document.getElementById('wrapper').innerHTML = tableStr;
</script>
<style>
html{
	font-family:Tahoma;
	font-size:14px;
	}
	
div.wrapper{ width:100%; }
	
table.building{
	border-collapse:separate;
	border-spacing:5px 0;
	margin:3em auto;
	}

table.building td.section { vertical-align:bottom }

table.section{
	border-collapse:separate;
	border-spacing:0px;
	margin:0;
	vertical-align:bottom;
	background-color:#ddd
	}
	
table.section td {
	text-align:center;
	font-size:10px;
	}
	
table.section td.flat{
	color:white;
	width:16px;
	height:16px;
	}

table.section td.flat div.popup {
	display: none;
	padding:0.5em .75em;
	margin:1.2em 0 0 1.2em;
	color:black;
	font-size:16px;
	background-color:white;
	text-align:left;
	border:1px solid grey;
	border-radius:.4em;
	}

table.section td.flat:hover div.popup {
	display: block;
	position: absolute;
	}
	
table.section td.floor{
	text-align:right;
	vertical-align:top;
	font-size:12px;
	padding-right:2px;
	width:16px;height:14px;
	background-color:white !important
	}

	
table.section td.roomsNum_0{
	border-bottom:1px solid #0047ff;
	border-left:1px solid #0047ff;
	background-color:#0085ff; }
table.section td.roomsNum_1{
	border-bottom:1px solid #0085ff;
	border-left:1px solid #0085ff;	
	background-color:#0047ff; }
table.section td.roomsNum_2{	
	border-bottom:1px solid #e37300;
	border-left:1px solid #e37300;	
	background-color:#ff9900; }
table.section td.roomsNum_3{
	border-bottom:1px solid #65cb3a;
	border-left:1px solid #65cb3a;
	background-color:#36b600; }
table.section td.roomsNum_4{
	border-bottom:1px solid #ff97ad;
	border-left:1px solid #ff97ad;
	background-color:#ff110b; }


	
table.section tr.sectionColumnsLegend td{
	background-color:#ddd;
	color:black;
	font-size:12px;
	}


</style>
</html>